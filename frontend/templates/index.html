<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Portfolio Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0 30px;
        }

        h1 {
            font-size: 2.5rem;
            color: #c0c0c0;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #141414;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #333;
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #c0c0c0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #b0b0b0;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0a0a0a;
            color: #e0e0e0;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #c0c0c0;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #333;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #c0c0c0;
            cursor: pointer;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #c0c0c0;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #c0c0c0;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #d0d0d0;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        .results-panel {
            display: none;
        }

        .results-panel.show {
            display: block;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #c0c0c0;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        .portfolio-chart {
            margin: 20px 0;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 60px;
            font-weight: 600;
        }

        .bar-container {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            background: #c0c0c0;
            border-radius: 4px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            font-size: 0.85rem;
            color: #0a0a0a;
        }

        .bar.excluded {
            background: #333;
            color: #888;
        }

        .selected-badge {
            display: inline-block;
            padding: 3px 10px;
            background: rgba(192, 192, 192, 0.1);
            border: 1px solid #666;
            border-radius: 20px;
            font-size: 0.8rem;
            margin: 3px;
            color: #c0c0c0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #c0c0c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(139, 0, 0, 0.2);
            border: 1px solid #8b0000;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none;
            color: #ff6666;
        }

        .error-message.show {
            display: block;
        }

        .info-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: rgba(192, 192, 192, 0.1);
            color: #c0c0c0;
            font-weight: 600;
        }

        .comparison-table td:first-child {
            text-align: left;
            color: #b0b0b0;
        }

        .comparison-table .quantum-col {
            color: #e0e0e0;
            font-weight: 600;
        }

        .comparison-table .classical-col {
            color: #888;
            font-weight: 600;
        }

        .comparison-table .diff-positive {
            color: #4caf50;
        }

        .comparison-table .diff-negative {
            color: #ff5252;
        }

        .comparison-panel {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-panel h3 {
            color: #888;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .convergence-panel {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .convergence-panel h3 {
            color: #888;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .convergence-chart {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .convergence-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        .convergence-status .converged {
            color: #4caf50;
        }

        .measurements-panel {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .measurements-panel h3 {
            color: #888;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .measurement-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .measurement-label {
            font-family: monospace;
            width: 80px;
            font-size: 0.85rem;
            color: #b0b0b0;
        }

        .measurement-bar-container {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 0 10px;
            overflow: hidden;
        }

        .measurement-bar-fill {
            height: 100%;
            background: #c0c0c0;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .measurement-prob {
            width: 50px;
            text-align: right;
            font-size: 0.85rem;
            color: #c0c0c0;
        }

        .settings-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            padding-top: 20px;
        }

        .settings-toggle {
            cursor: pointer;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .settings-toggle:hover {
            color: #c0c0c0;
        }

        .settings-content {
            display: none;
        }

        .settings-content.show {
            display: block;
        }

        /* Quality Score Badge */
        .quality-card {
            position: relative;
        }

        .quality-badge {
            font-size: 2rem;
            font-weight: bold;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
        }

        .quality-badge.grade-A { background: #c0c0c0; color: #0a0a0a; }
        .quality-badge.grade-B { background: #888; color: #0a0a0a; }
        .quality-badge.grade-C { background: #555; color: #e0e0e0; }
        .quality-badge.grade-D { background: #333; color: #e0e0e0; }
        .quality-badge.grade-F { background: #8b0000; color: #e0e0e0; }

        .quality-score-small {
            font-size: 0.9rem;
            color: #888;
        }

        .quality-details-toggle {
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
            margin-top: 5px;
        }

        .quality-details-toggle:hover {
            color: #c0c0c0;
        }

        .quality-details {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .quality-details.show {
            display: block;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row span:first-child { color: #888; }
        .detail-row span:last-child { color: #c0c0c0; }

        .circuit-panel {
            margin-top: 25px;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .circuit-panel h4 {
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Quantum Portfolio Optimizer</h1>
            <p class="subtitle">Optimize your investment portfolio using quantum computing</p>
        </header>

        <div class="main-content">
            <div class="input-panel panel">
                <h2><span>&#9881;</span> Configuration</h2>

                <div class="form-group">
                    <label for="tickers">Stock Tickers</label>
                    <input type="text" id="tickers" value="AAPL, GOOG, MSFT, AMZN" placeholder="AAPL, GOOG, MSFT, AMZN">
                    <p class="info-text">Comma-separated list of stock symbols</p>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="start_date">Start Date</label>
                        <input type="date" id="start_date" value="2023-01-01">
                    </div>
                    <div class="form-group">
                        <label for="end_date">End Date</label>
                        <input type="date" id="end_date" value="2024-01-01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="risk_factor">Risk Tolerance</label>
                    <div class="slider-container">
                        <span>Low</span>
                        <input type="range" id="risk_factor" min="0" max="1" step="0.1" value="0.5">
                        <span>High</span>
                        <span class="slider-value" id="risk_value">0.5</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="backend">Compute Backend</label>
                    <select id="backend" onchange="toggleIBMSettings()">
                        <option value="local_simulator">Local Simulator (Fast)</option>
                        <option value="ibm_quantum">IBM Quantum Hardware</option>
                    </select>
                </div>

                <div class="ibm-settings" id="ibm-settings" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(192, 192, 192, 0.05); border: 1px solid #444; border-radius: 8px;">
                    <label style="color: #c0c0c0; margin-bottom: 10px; display: block; font-weight: 600;">IBM Quantum Settings</label>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="ibm_api_key">API Key</label>
                        <input type="password" id="ibm_api_key" placeholder="Enter your IBM Quantum API key">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="ibm_channel">Access Channel</label>
                        <select id="ibm_channel" onchange="handleIBMChannelChange()">
                            <option value="ibm_quantum">IBM Quantum (Community)</option>
                            <option value="ibm_cloud">IBM Cloud (Premium)</option>
                        </select>
                        <p class="info-text">Use IBM Quantum for hub/group/project instances such as ibm-q/open/main</p>
                    </div>
                    <div class="form-group" id="ibm-instance-group" style="margin-bottom: 10px;">
                        <label for="ibm_instance">Instance (hub/group/project)</label>
                        <input type="text" id="ibm_instance" placeholder="ibm-q/open/main">
                    </div>
                    <div class="form-group" id="ibm-crn-group" style="margin-bottom: 10px; display: none;">
                        <label for="ibm_crn">Cloud Resource Name (CRN)</label>
                        <input type="text" id="ibm_crn" placeholder="crn:v1:bluemix:public:quantum-computing:...">
                        <p class="info-text">Required for IBM Cloud channel</p>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="ibm_device">Device</label>
                        <select id="ibm_device">
                            <option value="ibm_aachen">ibm_aachen (156 qubits)</option>
                            <option value="ibm_strasbourg">ibm_strasbourg (127 qubits)</option>
                            <option value="ibm_brussels">ibm_brussels (127 qubits)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="resilience_level">Resilience Level</label>
                        <select id="resilience_level" onchange="toggleZNEControls()">
                            <option value="0">Level 0 - None</option>
                            <option value="1" selected>Level 1 - Basic (DD + Twirling)</option>
                            <option value="2">Level 2 - Advanced (ZNE)</option>
                        </select>
                        <p class="info-text">Matches IBM 2026 workflow for community advantage tracking</p>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="ibm_zne">
                            Enable Zero-Noise Extrapolation
                        </label>
                    </div>
                    <div class="row" id="zne-options" style="display: none;">
                        <div class="form-group">
                            <label for="zne_noise_factors">ZNE Noise Factors</label>
                            <input type="text" id="zne_noise_factors" value="1,3,5">
                        </div>
                        <div class="form-group">
                            <label for="zne_extrapolator">ZNE Extrapolator</label>
                            <select id="zne_extrapolator">
                                <option value="linear">Linear</option>
                                <option value="exponential" selected>Exponential</option>
                                <option value="polynomial">Polynomial</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="ibm_dd" checked>
                                Dynamical Decoupling
                            </label>
                            <label for="dd_sequence" class="info-text" style="margin-top: 6px;">Sequence</label>
                            <select id="dd_sequence">
                                <option value="XpXm">XpXm</option>
                                <option value="XY4">XY4</option>
                                <option value="XX">XX</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="ibm_twirling" checked>
                                Pauli Twirling
                            </label>
                            <p class="info-text">Randomizes noise for better mitigation</p>
                        </div>
                    </div>
                    <p class="info-text" style="color: #888;">Real quantum hardware - runs may take longer due to queue times</p>
                </div>

                <div class="settings-section">
                    <div class="settings-toggle" onclick="toggleSettings()">
                        <span id="settings-arrow">&#9654;</span> Advanced Settings
                    </div>
                    <div class="settings-content" id="advanced-settings">
                        <div class="form-group">
                            <label for="algorithm">Algorithm</label>
                            <select id="algorithm" onchange="toggleAlgorithmSettings()">
                                <option value="vqe">VQE (Recommended for 10+ assets)</option>
                                <option value="qaoa">QAOA (Experimental)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="resolution">Allocation Precision</label>
                            <select id="resolution" onchange="updateQubitCount()">
                                <option value="1" selected>Binary (0% or 100%)</option>
                                <option value="2">4 levels (0%, 33%, 67%, 100%)</option>
                                <option value="3">8 levels (0%, 14%, 29%, ...)</option>
                            </select>
                            <p class="info-text">Higher precision requires more qubits</p>
                            <div id="qubit-warning" style="display: none; margin-top: 10px; padding: 10px; background: rgba(139, 0, 0, 0.2); border: 1px solid #8b0000; border-radius: 8px; font-size: 0.85rem; color: #ff6666;"></div>
                        </div>

                        <!-- VQE-specific settings -->
                        <div id="vqe-settings">
                            <div class="row">
                                <div class="form-group">
                                    <label for="ansatz">Ansatz Type</label>
                                    <select id="ansatz">
                                        <option value="RealAmplitudes">RealAmplitudes</option>
                                        <option value="EfficientSU2">EfficientSU2</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reps">Circuit Depth (reps)</label>
                                    <input type="number" id="reps" value="2" min="1" max="5">
                                </div>
                            </div>
                        </div>

                        <!-- QAOA-specific settings -->
                        <div id="qaoa-settings" style="display: none;">
                            <div class="form-group">
                                <label for="qaoa_layers">QAOA Layers (p)</label>
                                <select id="qaoa_layers">
                                    <option value="1">p=1 (Shallow - Recommended)</option>
                                    <option value="2">p=2 (Deeper)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cvar_alpha">CVaR Alpha (tail fraction)</label>
                                <div class="slider-container">
                                    <span>0.1</span>
                                    <input type="range" id="cvar_alpha" min="0.1" max="1.0" step="0.05" value="1.0">
                                    <span>1.0</span>
                                    <span class="slider-value" id="cvar_alpha_value">1.0</span>
                                </div>
                                <p class="info-text">1.0 = standard expectation; lower values focus on worst-case outcomes (CVaR-QAOA, Barkoutsos et al. 2020)</p>
                            </div>
                            <div class="form-group">
                                <label for="mixer_type">Mixer Type</label>
                                <select id="mixer_type">
                                    <option value="x">X-Mixer (standard)</option>
                                    <option value="xy">XY-Mixer + Dicke state (constraint-preserving)</option>
                                </select>
                                <p class="info-text">XY-mixer enforces exact cardinality without penalty tuning (Bartschi &amp; Eidenbenz 2019)</p>
                            </div>
                            <div id="qaoa-warning" style="background: rgba(192, 192, 192, 0.05); border: 1px solid #555; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                                <p style="color: #888; font-size: 0.85rem;">
                                    <strong style="color: #c0c0c0;">Note:</strong> QAOA circuits are deeper than VQE, which may result in higher noise on real hardware.
                                    VQE is recommended for problems with more than 15 assets.
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="maxiter">Max Iterations</label>
                            <input type="number" id="maxiter" value="50" min="10" max="500">
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="warm-start" checked style="width: auto;">
                                Warm start from classical solution
                            </label>
                            <p class="info-text">Initialize circuit parameters using Markowitz solution (recommended)</p>
                        </div>

                        <!-- 2026 Modular Hardware Support -->
                        <div class="form-group" style="border-top: 1px dashed #444; padding-top: 15px; margin-top: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #c0c0c0; font-weight: 600;">
                                <input type="checkbox" id="use_partitioning" style="width: auto;">
                                Enable Modular Partitioning (2026)
                            </label>
                            <p class="info-text">Supports IBM Kookaburra architecture by cutting circuits into sectors</p>
                        </div>

                        <div class="form-group">
                            <label for="sectors">Asset Sectors (JSON format)</label>
                            <textarea id="sectors" rows="3" style="width: 100%; background: #0a0a0a; color: #e0e0e0; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 0.85rem;" placeholder='{"Tech": [0, 1], "Energy": [2, 3]}'></textarea>
                            <p class="info-text">Define asset groups for partitioning. Indices match the ticker list order (0, 1, 2...).</p>
                        </div>
                    </div>
                </div>

                <!-- ESG & MIP section -->
                <div class="form-group" style="margin-top: 20px; padding: 15px; border: 1px solid #333; border-radius: 8px; background: rgba(255,255,255,0.02);">
                    <h4 style="margin-bottom: 12px; color: #c0c0c0;">ESG &amp; Integer Constraints</h4>

                    <div class="form-group">
                        <label for="esg_scores">ESG Scores (comma-separated, one per ticker)</label>
                        <input type="text" id="esg_scores" placeholder="e.g. 72, 85, 60, 90" value="">
                        <p class="info-text">Higher score = more sustainable. Leave blank to disable ESG weighting.</p>
                    </div>

                    <div class="form-group">
                        <label for="esg_weight">ESG Weight</label>
                        <div class="slider-container">
                            <span>0</span>
                            <input type="range" id="esg_weight" min="0" max="1" step="0.05" value="0">
                            <span>1</span>
                            <span class="slider-value" id="esg_weight_value">0</span>
                        </div>
                        <p class="info-text">Fraction of objective devoted to ESG score maximisation (0 = off)</p>
                    </div>

                    <div class="form-group">
                        <label for="num_assets_select">Assets to Select (MIP baseline &amp; XY-mixer)</label>
                        <input type="number" id="num_assets_select" value="" min="1" placeholder="Default: half of tickers">
                        <p class="info-text">Exact cardinality for the integer-constrained MIP baseline and XY-mixer QAOA</p>
                    </div>
                </div>

                <button class="btn btn-primary" id="optimize-btn" onclick="runOptimization()">
                    Run Optimization
                </button>

                <div class="error-message" id="error-message"></div>
            </div>

            <div class="panel">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <h3>Running Quantum Optimization...</h3>
                    <p style="color: #888; margin-top: 10px;">This may take a moment</p>
                </div>

                <div class="results-panel" id="results">
                    <h2><span>&#128200;</span> Optimization Results</h2>

                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="expected-return">-</div>
                            <div class="metric-label">Expected Return (Annual %)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="portfolio-risk">-</div>
                            <div class="metric-label">Portfolio Risk (%)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="sharpe-ratio">-</div>
                            <div class="metric-label">Sharpe Ratio</div>
                        </div>
                        <div class="metric-card quality-card" id="quality-card" style="display: none;">
                            <div class="quality-badge" id="quality-grade">-</div>
                            <div class="metric-label">Quality Score</div>
                            <div class="quality-score-small" id="quality-score-text">-/100</div>
                            <div class="quality-details-toggle" onclick="toggleQualityDetails()">Details ▼</div>
                        </div>
                        <div class="quality-details" id="quality-details">
                            <div class="detail-row"><span>Sharpe</span><span id="detail-sharpe">-</span></div>
                            <div class="detail-row"><span>Feasibility</span><span id="detail-feasibility">-</span></div>
                            <div class="detail-row"><span>Return</span><span id="detail-return">-</span></div>
                            <div class="detail-row"><span>vs Classical</span><span id="detail-vs_classical">-</span></div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px;">Recommended Portfolio</h3>
                    <div class="portfolio-chart">
                        <div class="bar-chart" id="allocation-chart"></div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #888;">Selected Assets</h4>
                        <div id="selected-assets"></div>
                    </div>

                    <div class="comparison-panel" id="comparison-panel">
                        <h3>Quantum vs Classical Comparison</h3>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Quantum</th>
                                    <th>Markowitz</th>
                                    <th>MIP (integer)</th>
                                    <th>vs Markowitz</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Expected Return</td>
                                    <td class="quantum-col" id="cmp-quantum-return">-</td>
                                    <td class="classical-col" id="cmp-classical-return">-</td>
                                    <td class="classical-col" id="cmp-mip-return">-</td>
                                    <td id="cmp-diff-return">-</td>
                                </tr>
                                <tr>
                                    <td>Portfolio Risk</td>
                                    <td class="quantum-col" id="cmp-quantum-risk">-</td>
                                    <td class="classical-col" id="cmp-classical-risk">-</td>
                                    <td class="classical-col" id="cmp-mip-risk">-</td>
                                    <td id="cmp-diff-risk">-</td>
                                </tr>
                                <tr>
                                    <td>Sharpe Ratio</td>
                                    <td class="quantum-col" id="cmp-quantum-sharpe">-</td>
                                    <td class="classical-col" id="cmp-classical-sharpe">-</td>
                                    <td class="classical-col" id="cmp-mip-sharpe">-</td>
                                    <td id="cmp-diff-sharpe">-</td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="mip-info" style="margin-top: 8px; font-size: 0.8rem; color: #666;"></div>
                    </div>

                    <div class="convergence-panel" id="convergence-panel">
                        <h3>Optimization Convergence</h3>
                        <div class="convergence-chart">
                            <canvas id="convergence-chart" width="400" height="150"></canvas>
                        </div>
                        <div class="convergence-status" id="convergence-status"></div>
                    </div>

                    <div class="measurements-panel" id="measurements-panel" style="display: none;">
                        <h3>Quantum Measurement Statistics</h3>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                            Top bitstring solutions from <span id="total-shots">-</span> shots
                        </p>
                        <div id="measurements-chart"></div>
                    </div>

                    <div style="margin-top: 20px; font-size: 0.85rem; color: #666;">
                        <p>Optimal QUBO Value: <span id="optimal-value">-</span></p>
                        <p>Iterations: <span id="iterations">-</span></p>
                        </div>
                    </div>

                    <div class="circuit-panel" id="circuit-panel" style="display: none;">
                        <h3>Quantum Circuit Details</h3>
                        <div class="detail-row"><span>Circuit</span><span id="circuit-name">-</span></div>
                        <div class="detail-row"><span>Algorithm</span><span id="circuit-algo">-</span></div>
                        <div class="detail-row"><span>Backend</span><span id="circuit-backend">-</span></div>
                        <div class="detail-row"><span>Qubits</span><span id="circuit-qubits">-</span></div>
                        <div class="detail-row"><span>Parameters</span><span id="circuit-params">-</span></div>
                        <div class="detail-row"><span>Depth</span><span id="circuit-depth">-</span></div>
                        <div class="detail-row"><span>Shots</span><span id="circuit-shots">-</span></div>
                    </div>

                <div id="welcome" style="text-align: center; padding: 60px 20px; color: #666;">
                    <div style="margin-bottom: 20px;">
                        <svg width="80" height="80" viewBox="0 0 80 80" style="opacity: 0.6;">
                            <!-- Quantum circuit visualization -->
                            <circle cx="40" cy="40" r="35" fill="none" stroke="#666" stroke-width="1" stroke-dasharray="4,4"/>
                            <circle cx="40" cy="40" r="20" fill="none" stroke="#888" stroke-width="1"/>
                            <circle cx="40" cy="40" r="4" fill="#888"/>
                            <!-- Orbital paths -->
                            <ellipse cx="40" cy="40" rx="30" ry="12" fill="none" stroke="#777" stroke-width="1" transform="rotate(45 40 40)"/>
                            <ellipse cx="40" cy="40" rx="30" ry="12" fill="none" stroke="#777" stroke-width="1" transform="rotate(-45 40 40)"/>
                            <!-- Electron markers -->
                            <circle cx="65" cy="28" r="3" fill="#999"/>
                            <circle cx="15" cy="52" r="3" fill="#999"/>
                        </svg>
                    </div>
                    <h3 style="color: #888; margin-bottom: 10px;">Ready to Optimize</h3>
                    <p>Configure your parameters and run the quantum optimization algorithm.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update risk slider value display
        document.getElementById('risk_factor').addEventListener('input', function() {
            document.getElementById('risk_value').textContent = this.value;
        });

        // CVaR alpha slider
        document.getElementById('cvar_alpha').addEventListener('input', function() {
            document.getElementById('cvar_alpha_value').textContent = this.value;
        });

        // ESG weight slider
        document.getElementById('esg_weight').addEventListener('input', function() {
            document.getElementById('esg_weight_value').textContent = this.value;
        });

        function toggleSettings() {
            const content = document.getElementById('advanced-settings');
            const arrow = document.getElementById('settings-arrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '▼' : '▶';
        }

        function toggleIBMSettings() {
            const backend = document.getElementById('backend').value;
            const ibmSettings = document.getElementById('ibm-settings');
            const shouldShow = backend === 'ibm_quantum';
            ibmSettings.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) {
                handleIBMChannelChange();
                toggleZNEControls();
            }
        }

        function handleIBMChannelChange() {
            const channel = document.getElementById('ibm_channel').value;
            const crnGroup = document.getElementById('ibm-crn-group');
            const instanceGroup = document.getElementById('ibm-instance-group');
            if (channel === 'ibm_cloud') {
                crnGroup.style.display = 'block';
                instanceGroup.style.display = 'none';
            } else {
                crnGroup.style.display = 'none';
                instanceGroup.style.display = 'block';
            }
        }

        function toggleZNEControls() {
            const resilience = parseInt(document.getElementById('resilience_level').value, 10);
            const zneCheckbox = document.getElementById('ibm_zne');
            const zneOptions = document.getElementById('zne-options');
            const enableZNE = resilience >= 2;
            zneCheckbox.disabled = !enableZNE;
            if (!enableZNE) {
                zneCheckbox.checked = false;
            }
            zneOptions.style.display = (enableZNE && zneCheckbox.checked) ? 'grid' : 'none';
        }

        function toggleAlgorithmSettings() {
            const algorithm = document.getElementById('algorithm').value;
            const vqeSettings = document.getElementById('vqe-settings');
            const qaoaSettings = document.getElementById('qaoa-settings');

            if (algorithm === 'vqe') {
                vqeSettings.style.display = 'block';
                qaoaSettings.style.display = 'none';
            } else {
                vqeSettings.style.display = 'none';
                qaoaSettings.style.display = 'block';
            }
        }

        function toggleQualityDetails() {
            const details = document.getElementById('quality-details');
            details.classList.toggle('show');
        }

        function clearElement(element) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }

        function buildAllocationChart(weights) {
            const chartDiv = document.getElementById('allocation-chart');
            clearElement(chartDiv);
            const fragment = document.createDocumentFragment();

            for (const [ticker, weightValue] of Object.entries(weights || {})) {
                const weight = Number(weightValue) || 0;
                const width = Math.max(0, Math.min(100, Math.max(weight, 5)));
                const isSelected = weight > 0;

                const row = document.createElement('div');
                row.className = 'bar-item';

                const label = document.createElement('span');
                label.className = 'bar-label';
                label.textContent = ticker;

                const container = document.createElement('div');
                container.className = 'bar-container';

                const bar = document.createElement('div');
                bar.className = isSelected ? 'bar' : 'bar excluded';
                bar.style.width = width + '%';
                bar.textContent = weight + '%';

                container.appendChild(bar);
                row.appendChild(label);
                row.appendChild(container);
                fragment.appendChild(row);
            }

            chartDiv.appendChild(fragment);
        }

        function buildSelectedAssets(selectedAssets) {
            const selectedDiv = document.getElementById('selected-assets');
            clearElement(selectedDiv);
            const fragment = document.createDocumentFragment();

            (selectedAssets || []).forEach(asset => {
                const badge = document.createElement('span');
                badge.className = 'selected-badge';
                badge.textContent = asset;
                fragment.appendChild(badge);
            });

            selectedDiv.appendChild(fragment);
        }

        function setConvergenceStatus(convergence) {
            const statusEl = document.getElementById('convergence-status');
            clearElement(statusEl);

            if (!convergence) {
                return;
            }

            if (convergence.converged) {
                const indicator = document.createElement('span');
                indicator.className = 'converged';
                indicator.textContent = '✓ Optimization converged';
                statusEl.appendChild(indicator);
                return;
            }

            statusEl.textContent = 'Optimization completed (' + convergence.history.length + ' evaluations)';
        }

        function buildMeasurementsChart(measurements) {
            const chartDiv = document.getElementById('measurements-chart');
            clearElement(chartDiv);

            const fragment = document.createDocumentFragment();
            (measurements.top_solutions || []).forEach(solution => {
                const row = document.createElement('div');
                row.className = 'measurement-bar';

                const label = document.createElement('span');
                label.className = 'measurement-label';
                label.textContent = solution.bitstring;

                const container = document.createElement('div');
                container.className = 'measurement-bar-container';

                const fill = document.createElement('div');
                fill.className = 'measurement-bar-fill';
                const probability = Number(solution.probability) || 0;
                fill.style.width = Math.max(0, Math.min(100, probability)) + '%';

                const probabilityLabel = document.createElement('span');
                probabilityLabel.className = 'measurement-prob';
                probabilityLabel.textContent = probability + '%';

                container.appendChild(fill);
                row.appendChild(label);
                row.appendChild(container);
                row.appendChild(probabilityLabel);
                fragment.appendChild(row);
            });

            chartDiv.appendChild(fragment);
        }

        function updateQubitCount() {
            const tickers = document.getElementById('tickers').value.split(',').filter(t => t.trim()).length;
            const resolution = parseInt(document.getElementById('resolution').value);
            const totalQubits = tickers * resolution;
            const warning = document.getElementById('qubit-warning');

            if (totalQubits > 20) {
                warning.style.display = 'block';
                warning.textContent = 'Warning: ' + totalQubits + ' qubits needed. May be slow on simulator.';
            } else {
                warning.style.display = 'none';
            }
        }

        // Update qubit count when tickers change
        document.getElementById('tickers').addEventListener('input', updateQubitCount);
        document.getElementById('ibm_zne').addEventListener('change', toggleZNEControls);

        function drawConvergenceChart(history, bestHistory) {
            const canvas = document.getElementById('convergence-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            if (!bestHistory || bestHistory.length === 0) return;

            // Find data range
            const minVal = Math.min(...bestHistory);
            const maxVal = Math.max(...bestHistory);
            const range = maxVal - minVal || 1;

            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Draw best history line
            ctx.strokeStyle = '#c0c0c0';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < bestHistory.length; i++) {
                const x = padding + (width - 2 * padding) * i / (bestHistory.length - 1 || 1);
                const y = height - padding - (height - 2 * padding) * (bestHistory[i] - minVal) / range;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw labels
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Iteration', width / 2, height - 5);

            ctx.save();
            ctx.translate(12, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Energy', 0, 0);
            ctx.restore();

            // Draw min/max values
            ctx.textAlign = 'left';
            ctx.fillText(maxVal.toFixed(3), 5, padding + 10);
            ctx.fillText(minVal.toFixed(3), 5, height - padding);
        }

        async function runOptimization() {
            const btn = document.getElementById('optimize-btn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const welcome = document.getElementById('welcome');
            const errorMsg = document.getElementById('error-message');

            // Gather form data
            const backend = document.getElementById('backend').value;
            const algorithm = document.getElementById('algorithm').value;
            const data = {
                tickers: document.getElementById('tickers').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                risk_factor: document.getElementById('risk_factor').value,
                backend: backend,
                algorithm: algorithm,
                ibm_device: document.getElementById('ibm_device').value,
                ibm_api_key: document.getElementById('ibm_api_key').value,
                ibm_crn: document.getElementById('ibm_crn').value,
                ibm_channel: document.getElementById('ibm_channel').value,
                ibm_instance: document.getElementById('ibm_instance').value,
                resilience_level: document.getElementById('resilience_level').value,
                zne_enabled: document.getElementById('ibm_zne').checked,
                zne_noise_factors: document.getElementById('zne_noise_factors').value,
                zne_extrapolator: document.getElementById('zne_extrapolator').value,
                dd_enabled: document.getElementById('ibm_dd').checked,
                dd_sequence: document.getElementById('dd_sequence').value,
                twirling_enabled: document.getElementById('ibm_twirling').checked,
                ansatz: document.getElementById('ansatz').value,
                reps: document.getElementById('reps').value,
                qaoa_layers: document.getElementById('qaoa_layers').value,
                maxiter: document.getElementById('maxiter').value,
                warm_start: document.getElementById('warm-start').checked,
                resolution_qubits: document.getElementById('resolution').value,
                cvar_alpha: document.getElementById('cvar_alpha').value,
                mixer_type: document.getElementById('mixer_type').value,
                esg_scores: document.getElementById('esg_scores').value,
                esg_weight: document.getElementById('esg_weight').value,
                num_assets_select: document.getElementById('num_assets_select').value || null,
                use_partitioning: document.getElementById('use_partitioning').checked,
                sectors: (function() {
                    const raw = document.getElementById('sectors').value.strip;
                    try { return raw ? JSON.parse(document.getElementById('sectors').value) : null; }
                    catch(e) { console.error("Invalid sectors JSON", e); return null; }
                })(),
            };

            // Validate IBM credentials if IBM Quantum is selected
            if (backend === 'ibm_quantum') {
                if (!data.ibm_api_key) {
                    alert('Please enter your IBM Quantum API Key');
                    return;
                }
                if (data.ibm_channel === 'ibm_cloud' && !data.ibm_crn) {
                    alert('IBM Cloud channel requires a Cloud Resource Name (CRN)');
                    return;
                }
            }

            // Update loading message based on backend
            const loadingTitle = document.querySelector('#loading h3');
            const loadingSubtext = document.querySelector('#loading p');
            if (backend === 'ibm_quantum') {
                loadingTitle.textContent = 'Running on IBM Quantum Hardware...';
                loadingSubtext.textContent = 'Submitting to ' + data.ibm_device + ' - this may take a few minutes';
            } else {
                loadingTitle.textContent = 'Running Quantum Optimization...';
                loadingSubtext.textContent = 'This may take a moment';
            }

            // Show loading
            btn.disabled = true;
            loading.classList.add('show');
            results.classList.remove('show');
            welcome.style.display = 'none';
            errorMsg.classList.remove('show');

            try {
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                // Update metrics
                document.getElementById('expected-return').textContent = result.expected_return + '%';
                document.getElementById('portfolio-risk').textContent = result.portfolio_risk + '%';
                document.getElementById('sharpe-ratio').textContent = result.sharpe_ratio;
                document.getElementById('optimal-value').textContent = result.optimal_value;
                document.getElementById('iterations').textContent = result.iterations;

                // Update allocation chart and selected assets
                buildAllocationChart(result.weights);
                buildSelectedAssets(result.selected_assets);

                // Update comparison table
                if (result.classical_baseline) {
                    const cb = result.classical_baseline;

                    // Update quantum values
                    document.getElementById('cmp-quantum-return').textContent = result.expected_return + '%';
                    document.getElementById('cmp-quantum-risk').textContent = result.portfolio_risk + '%';
                    document.getElementById('cmp-quantum-sharpe').textContent = result.sharpe_ratio;

                    // Update Markowitz values
                    document.getElementById('cmp-classical-return').textContent = cb.expected_return + '%';
                    document.getElementById('cmp-classical-risk').textContent = cb.portfolio_risk + '%';
                    document.getElementById('cmp-classical-sharpe').textContent = cb.sharpe_ratio;

                    // Update MIP values
                    const mip = result.mip_baseline;
                    if (mip && mip.success) {
                        document.getElementById('cmp-mip-return').textContent = mip.expected_return + '%';
                        document.getElementById('cmp-mip-risk').textContent = mip.portfolio_risk + '%';
                        document.getElementById('cmp-mip-sharpe').textContent = mip.sharpe_ratio;
                        document.getElementById('mip-info').textContent =
                            `MIP: ${mip.num_assets_selected} assets selected — ${mip.message}`;
                    } else {
                        document.getElementById('cmp-mip-return').textContent = 'n/a';
                        document.getElementById('cmp-mip-risk').textContent = 'n/a';
                        document.getElementById('cmp-mip-sharpe').textContent = 'n/a';
                        document.getElementById('mip-info').textContent =
                            mip ? mip.message : 'MIP baseline not computed';
                    }

                    // Calculate and display vs-Markowitz differences
                    const returnDiff = (result.expected_return - cb.expected_return).toFixed(2);
                    const riskDiff = (result.portfolio_risk - cb.portfolio_risk).toFixed(2);
                    const sharpeDiff = (result.sharpe_ratio - cb.sharpe_ratio).toFixed(2);

                    const returnDiffEl = document.getElementById('cmp-diff-return');
                    const riskDiffEl = document.getElementById('cmp-diff-risk');
                    const sharpeDiffEl = document.getElementById('cmp-diff-sharpe');

                    // Return: higher is better
                    returnDiffEl.textContent = (returnDiff >= 0 ? '+' : '') + returnDiff + '%';
                    returnDiffEl.className = returnDiff >= 0 ? 'diff-positive' : 'diff-negative';

                    // Risk: lower is better
                    riskDiffEl.textContent = (riskDiff >= 0 ? '+' : '') + riskDiff + '%';
                    riskDiffEl.className = riskDiff <= 0 ? 'diff-positive' : 'diff-negative';

                    // Sharpe: higher is better
                    sharpeDiffEl.textContent = (sharpeDiff >= 0 ? '+' : '') + sharpeDiff;
                    sharpeDiffEl.className = sharpeDiff >= 0 ? 'diff-positive' : 'diff-negative';
                }

                // Draw convergence chart
                if (result.convergence) {
                    drawConvergenceChart(result.convergence.history, result.convergence.best_history);
                    setConvergenceStatus(result.convergence);
                }

                // Display measurement statistics
                if (result.measurements) {
                    document.getElementById('measurements-panel').style.display = 'block';
                    document.getElementById('total-shots').textContent = result.measurements.total_shots;
                    buildMeasurementsChart(result.measurements);
                } else {
                    document.getElementById('measurements-panel').style.display = 'none';
                }

                const circuitPanel = document.getElementById('circuit-panel');
                if (result.circuit_report) {
                    circuitPanel.style.display = 'block';
                    const report = result.circuit_report;
                    document.getElementById('circuit-name').textContent = report.name || '-';
                    document.getElementById('circuit-algo').textContent = report.algorithm || '-';
                    document.getElementById('circuit-backend').textContent = report.backend || '-';
                    document.getElementById('circuit-qubits').textContent = report.num_qubits ?? '-';
                    document.getElementById('circuit-params').textContent = report.num_parameters ?? '-';
                    document.getElementById('circuit-depth').textContent = report.depth ?? '-';
                    document.getElementById('circuit-shots').textContent = report.shots ?? '-';
                } else {
                    circuitPanel.style.display = 'none';
                }

                // Display quality score
                if (result.quality_score) {
                    const qs = result.quality_score;
                    document.getElementById('quality-card').style.display = 'block';

                    const badge = document.getElementById('quality-grade');
                    badge.textContent = qs.grade;
                    badge.className = 'quality-badge grade-' + qs.grade;

                    document.getElementById('quality-score-text').textContent = qs.total_score + '/100';

                    // Update detail components
                    if (qs.components) {
                        const detailSharpe = document.getElementById('detail-sharpe');
                        const detailFeasibility = document.getElementById('detail-feasibility');
                        const detailReturn = document.getElementById('detail-return');
                        const detailVsClassical = document.getElementById('detail-vs_classical');

                        if (detailSharpe && qs.components.sharpe !== undefined) {
                            detailSharpe.textContent = Math.round(qs.components.sharpe);
                        }
                        if (detailFeasibility && qs.components.feasibility !== undefined) {
                            detailFeasibility.textContent = Math.round(qs.components.feasibility);
                        }
                        if (detailReturn && qs.components.return !== undefined) {
                            detailReturn.textContent = Math.round(qs.components.return);
                        }
                        if (detailVsClassical && qs.components.vs_classical !== undefined) {
                            detailVsClassical.textContent = Math.round(qs.components.vs_classical);
                        }
                    }

                    // Reset details panel
                    document.getElementById('quality-details').classList.remove('show');
                }

                // Show results
                loading.classList.remove('show');
                results.classList.add('show');

            } catch (error) {
                loading.classList.remove('show');
                errorMsg.textContent = 'Error: ' + error.message;
                errorMsg.classList.add('show');
                welcome.style.display = 'block';
            }

            btn.disabled = false;
        }

        window.addEventListener('load', () => {
            toggleIBMSettings();
            toggleAlgorithmSettings();
            updateQubitCount();
            handleIBMChannelChange();
            toggleZNEControls();
        });
    </script>
</body>
</html>
